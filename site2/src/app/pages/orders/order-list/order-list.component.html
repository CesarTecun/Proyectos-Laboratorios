<div class="container my-4">
  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="h4 mb-1">Órdenes</h2>
      <p class="text-muted mb-0">Listado de órdenes del sistema.</p>
    </div>
    <div class="d-flex gap-2">
      <button mat-raised-button color="primary" [routerLink]="['/orders/new']">
        <mat-icon>add</mat-icon>
        <span class="ms-1 d-none d-md-inline">Nueva Orden</span>
      </button>
      <button class="btn btn-outline-secondary" (click)="reload()" [disabled]="isLoading()">
        <span class="spinner-border spinner-border-sm me-1" *ngIf="isLoading()"></span>
        Recargar
      </button>
    </div>
  </div>

  <!-- Error -->
  <div class="alert alert-danger d-flex align-items-center" *ngIf="error()">
    <mat-icon class="me-2">error</mat-icon>
    <div>{{ error() }}</div>
  </div>

  <!-- Toolbar (búsqueda / estado / orden / dirección) -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-4">
          <label class="form-label mb-1">Buscar</label>
          <input
            class="form-control"
            placeholder="Por #orden, cliente o email…"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
          />
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label mb-1">Estado</label>
          <select
            class="form-select"
            [(ngModel)]="statusFilter"
            (ngModelChange)="onStatusFilterChange()"
          >
            <option [ngValue]="''">Todos</option>
            <option [ngValue]="'PENDING'">Pendiente</option>
            <option [ngValue]="'COMPLETED'">Completada</option>
            <option [ngValue]="'CANCELLED'">Cancelada</option>
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label mb-1">Ordenar por</label>
          <select
            class="form-select"
            [(ngModel)]="sortKey"
            (change)="applyFilters()"
          >
            <option value="createdAt">Fecha</option>
            <option value="id">ID</option>
            <option value="customerName">Cliente</option>
            <option value="total">Total</option>
            <option value="status">Estado</option>
          </select>
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label mb-1">Dirección</label>
          <div class="btn-group w-100" role="group" aria-label="Dirección de ordenamiento">
            <button type="button" class="btn btn-outline-primary" [class.active]="sortDir==='asc'" (click)="sortDir='asc'; applyFilters()">Asc</button>
            <button type="button" class="btn btn-outline-primary" [class.active]="sortDir==='desc'" (click)="sortDir='desc'; applyFilters()">Desc</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de órdenes -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Creada</th>
            <th>Actualizada</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>

        <!-- Loading State -->
        <tbody *ngIf="isLoading()">
          <tr *ngFor="let _ of [].constructor(5)">
            <td colspan="7">
              <div class="placeholder-glow">
                <span class="placeholder col-1 me-2"></span>
                <span class="placeholder col-3 me-2"></span>
                <span class="placeholder col-1 me-2"></span>
                <span class="placeholder col-2 me-2"></span>
                <span class="placeholder col-2 me-2"></span>
                <span class="placeholder col-2 me-2"></span>
              </div>
            </td>
          </tr>
        </tbody>

        <!-- Orders List -->
        <tbody *ngIf="!isLoading() && filteredOrders.length > 0">
          <tr *ngFor="let order of pagedOrders">
            <td>#{{ order.number || order.id }}</td>
            <td class="text-truncate" style="max-width: 260px;" [title]="order.customerName">
              {{ order.customerName || '—' }}
              <small class="text-muted d-block" *ngIf="order.customerEmail">{{ order.customerEmail }}</small>
            </td>
            <td>{{ getOrderTotal(order) | currency }}</td>
            <td>
              <span class="badge" [ngClass]="{
                'bg-warning text-dark': order.status === 'PENDING',
                'bg-success': order.status === 'COMPLETED',
                'bg-danger': order.status === 'CANCELLED' || order.status === 'CANCELED'
              }">
                {{ order.status || 'PENDING' }}
              </span>
            </td>
            <td>{{ order.createdAt | date:'short' }}</td>
            <td>{{ order.updatedAt ? (order.updatedAt | date:'short') : '—' }}</td>
            <td class="text-end">
              <button mat-icon-button color="primary" [routerLink]="['/orders', order.id]" matTooltip="Ver/Editar">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="updateOrderStatus(order.id, 'COMPLETED')" matTooltip="Marcar como completada" *ngIf="order.status !== 'COMPLETED'">
                <mat-icon>check_circle</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="updateOrderStatus(order.id, 'CANCELLED')" matTooltip="Cancelar orden" *ngIf="order.status !== 'CANCELLED' && order.status !== 'CANCELED'">
                <mat-icon>cancel</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteOrder(order.id)" matTooltip="Eliminar">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>

        <!-- Empty State -->
        <tbody *ngIf="!isLoading() && filteredOrders.length === 0">
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="text-muted">No se encontraron órdenes</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="card-footer d-flex flex-wrap align-items-center gap-2 justify-content-between" *ngIf="filteredOrders.length > 0">
      <div class="text-muted small">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }}–{{ Math.min(currentPage * pageSize, filteredOrders.length) }} de {{ filteredOrders.length }}
      </div>
      <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()">
          <option [ngValue]="5">5 por página</option>
          <option [ngValue]="10">10 por página</option>
          <option [ngValue]="25">25 por página</option>
          <option [ngValue]="50">50 por página</option>
        </select>
        <div class="btn-group">
          <button type="button" class="btn btn-outline-secondary btn-sm" [disabled]="currentPage === 1" (click)="previousPage()" matTooltip="Página anterior">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" [disabled]="currentPage === totalPages" (click)="nextPage()" matTooltip="Página siguiente">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
