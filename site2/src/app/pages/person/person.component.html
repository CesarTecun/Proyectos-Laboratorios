<div class="container my-4">
  <!-- 
    Encabezado de la vista:
    - Título y descripción.
    - Botones de acción: crear persona (abre diálogo) y recargar (deshabilitado si está cargando).
  -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="h4 mb-1">Personas</h2>
      <p class="text-muted mb-0">Listado de personas registradas en el sistema.</p>
    </div>
    <div class="d-flex gap-2">
      <!-- Alta de persona: abre PersonEditComponent sin datos (modo crear) -->
      <button mat-raised-button color="primary" (click)="openDialog()">
        <mat-icon>person_add</mat-icon>
        <span class="ms-1 d-none d-md-inline">Nueva persona</span>
      </button>

      <!-- Recarga la lista desde el backend -->
      <button class="btn btn-outline-secondary" (click)="reload()" [disabled]="isLoading()">
        <span class="spinner-border spinner-border-sm me-1" *ngIf="isLoading()"></span>
        Recargar
      </button>
    </div>
  </div>

  <!-- 
    Barra de herramientas:
    - Búsqueda por nombre, apellido o correo.
    - Selección de campo para ordenar.
    - Dirección de orden (asc/desc).
    Notas:
    * Se usa Bootstrap para layout y controles; Angular Material sólo para iconos/botones.
    * Con signals, se debe leer con query() y setear con query.set($event).
  -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6">
          <label for="search" class="form-label mb-1">Buscar</label>
          <input
            id="search"
            type="text"
            class="form-control"
            placeholder="Filtra por nombre, apellido o correo…"
            [ngModel]="query()"
            (ngModelChange)="query.set($event); applyFilter()"
          />
        </div>

        <!-- Ordenar por: actualiza sortKey (signal) y vuelve a página 1 -->
        <div class="col-6 col-md-3">
          <label class="form-label mb-1">Ordenar por</label>
          <select
            class="form-select"
            [ngModel]="sortKey()"
            (ngModelChange)="sortKey.set($event); goToPage(1)"
          >
            <option value="id">ID</option>
            <option value="firstName">Nombre</option>
            <option value="lastName">Apellido</option>
            <option value="email">Correo</option>
          </select>
        </div>

        <!-- Dirección de ordenamiento: usa helpers setDir y reinicia a página 1 -->
        <div class="col-6 col-md-3">
          <label class="form-label mb-1">Dirección</label>
          <div class="btn-group d-flex" role="group" aria-label="Dirección de ordenamiento">
            <button
              class="btn btn-outline-primary"
              [class.active]="sortDir()==='asc'"
              (click)="setDir('asc')"
            >
              Asc
            </button>
            <button
              class="btn btn-outline-primary"
              [class.active]="sortDir()==='desc'"
              (click)="setDir('desc')"
            >
              Desc
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 
    Área de alertas:
    - Muestra mensajes de error capturados en la carga o en operaciones.
  -->
  <div class="alert alert-danger d-flex align-items-center" *ngIf="error()">
    <mat-icon class="me-2">error</mat-icon>
    <div>{{ error() }}</div>
  </div>

  <!-- 
    Tabla de resultados:
    - Cabecera estática (ID, Nombre, Apellido, Correo, Acciones).
    - Tres estados en tbody:
      1) Loading skeleton (mientras isLoading()).
      2) Datos (cuando hay paged().length > 0).
      3) Estado vacío (cuando no hay resultados y no está cargando).
    - Acciones por fila: editar (abre diálogo con la persona), eliminar (SweetAlert2).
  -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Nombre</th>
            <th scope="col">Apellido</th>
            <th scope="col">Correo</th>
            <th scope="col" class="text-end">Acciones</th>
          </tr>
        </thead>

        <!-- Estado: cargando (skeleton placeholders) -->
        <tbody *ngIf="isLoading()">
          <tr *ngFor="let _ of [1,2,3,4,5]">
            <td colspan="5">
              <div class="placeholder-glow">
                <span class="placeholder col-2 me-2"></span>
                <span class="placeholder col-3 me-2"></span>
                <span class="placeholder col-4 me-2"></span>
                <span class="placeholder col-2"></span>
              </div>
            </td>
          </tr>
        </tbody>

        <!-- Estado: datos disponibles -->
        <tbody *ngIf="!isLoading() && paged().length > 0">
          <tr *ngFor="let person of paged()">
            <td>{{ person.id }}</td>
            <td class="fw-medium">{{ person.firstName || '—' }}</td>
            <td>{{ person.lastName || '—' }}</td>
            <td>
              <!-- Renderiza mailto si hay email, en caso contrario muestra guion largo -->
              <a *ngIf="person.email; else noEmail" [href]="'mailto:' + person.email">{{ person.email }}</a>
              <ng-template #noEmail>—</ng-template>
            </td>
            <td class="text-end">
              <!-- Editar: abre diálogo con la persona seleccionada -->
              <button
                mat-icon-button
                color="primary"
                (click)="openDialog(person)"
                matTooltip="Editar"
                aria-label="Editar persona"
              >
                <mat-icon>edit</mat-icon>
              </button>

              <!-- Eliminar: confirma y elimina por id -->
              <button
                mat-icon-button
                color="warn"
                (click)="deletePerson(person.id)"
                matTooltip="Eliminar"
                aria-label="Eliminar persona"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>

        <!-- Estado: sin resultados -->
        <tbody *ngIf="!isLoading() && paged().length === 0">
          <tr>
            <td colspan="5" class="text-center py-4 text-muted">
              No se encontraron resultados.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 
      Pie con paginación:
      - Indica el rango visible actual y total.
      - Selector de tamaño de página: sincroniza con signal pageSize.
      - Navegación anterior/siguiente: deshabilita en límites.
      Notas:
      * Con signals, el select usa [ngModel] y (ngModelChange) -> setPageSize($event).
    -->
    <div class="card-footer d-flex flex-wrap align-items-center gap-2 justify-content-between">
      <div class="text-muted small">
        Mostrando {{ (page() - 1) * pageSize() + 1 }}–
        {{ Math.min(page() * pageSize(), totalItems()) }} de {{ totalItems() }}
      </div>

      <div class="d-flex align-items-center gap-2">
        <!-- Tamaño de página: al cambiar, reinicia a la página 1 -->
        <select
          class="form-select form-select-sm w-auto"
          [ngModel]="pageSize()"
          (ngModelChange)="setPageSize($event)"
          aria-label="Tamaño de página"
        >
          <option [ngValue]="5">5</option>
          <option [ngValue]="10">10</option>
          <option [ngValue]="25">25</option>
        </select>

        <!-- Controles de paginación: prev/next + indicador de página actual -->
        <div class="btn-group" role="group" aria-label="Paginación">
          <button
            class="btn btn-outline-secondary btn-sm"
            (click)="prevPage()"
            [disabled]="page() === 1"
            aria-label="Página anterior"
          >
            «
          </button>
          <span class="btn btn-outline-secondary btn-sm disabled">
            Página {{ page() }} / {{ totalPages() }}
          </span>
          <button
            class="btn btn-outline-secondary btn-sm"
            (click)="nextPage()"
            [disabled]="page() === totalPages()"
            aria-label="Página siguiente"
          >
            »
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
